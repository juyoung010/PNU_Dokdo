<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë…ë„ ì˜ê²¬ ê²Œì‹œíŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body { font-family: 'Pretendard', sans-serif; }
    .input-focus:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 1);
    }
    .loading-overlay { display: none; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(2px); }
    .loading-overlay.active { display: flex; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">

  <!-- âœ… API URL (ì´ë¯¸ ë„¤ ë°°í¬ URLë¡œ ì„¸íŒ…ë¨) -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxxMeaTzal26xp8uSf4Ix_5g240Dxr8qnIhfFRHcuVpQE3tj7HuV-jJGjS_lGMmvsTL/exec";
  </script>

  <!-- Loading -->
  <div id="loader" class="loading-overlay fixed inset-0 z-[100] items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
  </div>

  <!-- Nav -->
  <nav class="fixed top-0 left-0 right-0 z-[60] bg-white/90 backdrop-blur-md border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="p-1.5 bg-blue-600 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <span class="font-bold text-lg tracking-tight">ë…ë„ ì˜ê²¬ ê²Œì‹œíŒ</span>
      </div>
      <div id="status" class="text-xs text-slate-400 font-medium">ì—°ê²° í™•ì¸ ì¤‘...</div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 pt-32 pb-20">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-4xl font-black text-slate-900 mb-3">ë…ë„ì—ê²Œ í•œë§ˆë””</h1>
      <p class="text-slate-500">ìš°ë¦¬ ë•… ë…ë„ë¥¼ í–¥í•œ ì—¬ëŸ¬ë¶„ì˜ ì†Œì¤‘í•œ ìƒê°ê³¼ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
    </div>

    <!-- Notice -->
    <div id="notice" class="hidden mb-6 rounded-2xl border p-4 text-sm"></div>

    <!-- Form -->
    <section class="bg-white rounded-3xl shadow-xl p-8 border border-slate-100 mb-12">
      <form id="opinionForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">ì‘ì„±ì</label>
            <input id="author" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                   class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus"/>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">ë¶„ë¥˜</label>
            <select id="category"
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus">
              <option value="ì‘ì›">ğŸ“£ ë…ë„ ì‘ì›</option>
              <option value="ì˜ê²¬">ğŸ’¡ ì •ì±…/ê°œì„  ì˜ê²¬</option>
              <option value="ê¸°íƒ€">ğŸ“ ê¸°íƒ€</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">ì˜ê²¬ ë‚´ìš©</label>
          <textarea id="content" required rows="4" placeholder="ë…ë„ì— ëŒ€í•œ ì†Œì¤‘í•œ ì˜ê²¬ì„ ì ì–´ì£¼ì„¸ìš”..."
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus resize-none"></textarea>
        </div>

        <div class="flex justify-end">
          <button id="submitBtn" type="submit"
                  class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            ë“±ë¡í•˜ê¸°
          </button>
        </div>
      </form>
    </section>

    <!-- List -->
    <section>
      <div class="flex items-center justify-between mb-6 px-2">
        <h2 class="text-xl font-black text-slate-800 flex items-center gap-2">
          ë“±ë¡ëœ ì˜ê²¬ <span id="count" class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">0</span>
        </h2>
        <button id="refreshBtn" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
          ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div id="opinionList" class="space-y-4">
        <div class="text-center py-10 text-slate-400">ì˜ê²¬ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>

      <div id="emptyState" class="hidden text-center py-20 bg-white rounded-3xl border border-dashed border-slate-300">
        <p class="text-slate-400">ì•„ì§ ë“±ë¡ëœ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
      </div>
    </section>
  </main>

  <footer class="bg-slate-900 text-slate-500 py-10 px-4 text-center">
    <p class="text-sm">Â© <span id="currentYear"></span> Dokdo Board. Powered by Google Apps Script API.</p>
  </footer>

  <script>
    const loader = document.getElementById('loader');
    const notice = document.getElementById('notice');
    const statusEl = document.getElementById('status');

    const opinionForm = document.getElementById('opinionForm');
    const submitBtn = document.getElementById('submitBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    const opinionList = document.getElementById('opinionList');
    const emptyState = document.getElementById('emptyState');
    const countSpan = document.getElementById('count');

    document.getElementById('currentYear').textContent = new Date().getFullYear();

    function setLoading(on) {
      if (on) loader.classList.add('active');
      else loader.classList.remove('active');
    }

    function showNotice(type, message) {
      notice.classList.remove('hidden');
      notice.className = 'mb-6 rounded-2xl border p-4 text-sm';
      if (type === 'error') notice.classList.add('bg-red-50','border-red-200','text-red-700');
      else if (type === 'success') notice.classList.add('bg-emerald-50','border-emerald-200','text-emerald-700');
      else notice.classList.add('bg-slate-50','border-slate-200','text-slate-700');
      notice.textContent = message;
    }

    function hideNotice() {
      notice.classList.add('hidden');
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    async function pingApi() {
      try {
        const res = await fetch(API_URL + '?ping=1', { method: 'GET' });
        const data = await res.json();
        if (data && data.ok) {
          statusEl.textContent = 'êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ë¨';
          statusEl.className = 'text-xs text-slate-400 font-medium';
          hideNotice();
        } else {
          throw new Error('ping failed');
        }
      } catch (e) {
        statusEl.textContent = 'ì—°ê²° ì˜¤ë¥˜ (ë°°í¬/ê¶Œí•œ í™•ì¸)';
        statusEl.className = 'text-xs text-red-500 font-semibold';
        showNotice('error', 'API ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Apps Script ì›¹ì•± ë°°í¬ê°€ â€œëª¨ë“  ì‚¬ìš©ìâ€ë¡œ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      }
    }

    async function loadOpinions() {
      setLoading(true);
      try {
        const res = await fetch(API_URL, { method: 'GET' });
        const data = await res.json();
        renderOpinions(Array.isArray(data) ? data : []);
      } catch (e) {
        console.error(e);
        setLoading(false);
        showNotice('error', 'ì˜ê²¬ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë°°í¬/ê¶Œí•œ í™•ì¸)');
      }
    }

    function renderOpinions(list) {
      setLoading(false);
      opinionList.innerHTML = '';
      const opinions = list || [];
      countSpan.textContent = opinions.length;

      if (opinions.length === 0) {
        emptyState.classList.remove('hidden');
        opinionList.innerHTML = '<div class="text-center py-10 text-slate-400">ë“±ë¡ëœ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      emptyState.classList.add('hidden');

      opinions.forEach(op => {
        const date = op.timestamp ? new Date(op.timestamp).toLocaleString() : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
        const author = (op.author || 'ìµëª…').toString();
        const initial = author.trim() ? author.trim()[0] : '?';
        const category = (op.category || 'ê¸°íƒ€').toString();
        const content = (op.content || '').toString();

        const item = `
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold uppercase">
                  ${escapeHtml(initial)}
                </div>
                <div>
                  <div class="font-bold text-slate-900">${escapeHtml(author)}</div>
                  <div class="text-[10px] text-slate-400 font-medium">${escapeHtml(date)}</div>
                </div>
              </div>
              <span class="px-2 py-1 rounded-md bg-slate-100 text-slate-600 text-[10px] font-bold">${escapeHtml(category)}</span>
            </div>
            <p class="text-slate-600 leading-relaxed text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
          </div>
        `;
        opinionList.insertAdjacentHTML('beforeend', item);
      });
    }

    async function postOpinion(formData) {
      setLoading(true);
      submitBtn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await res.json();

        if (result && result.success) {
          opinionForm.reset();
          showNotice('success', 'ì˜ê²¬ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          await loadOpinions();
        } else {
          setLoading(false);
          showNotice('error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        console.error(e);
        setLoading(false);
        showNotice('error', 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë°°í¬/ê¶Œí•œ í™•ì¸)');
      } finally {
        submitBtn.disabled = false;
      }
    }

    opinionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      hideNotice();

      const author = document.getElementById('author').value.trim();
      const category = document.getElementById('category').value.trim();
      const content = document.getElementById('content').value.trim();

      if (!author || !category || !content) {
        showNotice('error', 'ì‘ì„±ì/ë¶„ë¥˜/ë‚´ìš©ì€ ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      postOpinion({ author, category, content });
    });

    refreshBtn.addEventListener('click', loadOpinions);

    window.onload = async () => {
      await pingApi();
      await loadOpinions();
    };
  </script>
</body>
</html>
